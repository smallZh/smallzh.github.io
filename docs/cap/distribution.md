## 分布式相关问题
---

## 分布式与集群的区别? ⭐ :id=dis-colony
分布式是指将不同的业务分布在不同的地⽅。 ⽽集群指的是将⼏台服务器集中在⼀起，实现同⼀业务。

## 分布式事务？ ⭐⭐⭐ :id=dis-affair
**⼆阶段提交：**

1. 概念：参与者将操作成败通知协调者，再由协调者根据所有参与者的反馈情报决定各参与者是否要提交操作还是中⽌操作。
1. 作⽤：主要保证了分布式事务的原⼦性；第⼀阶段为准备阶段，第⼆阶段为提交阶段；
2. 缺点：不仅要锁住参与者的所有资源，⽽且要锁住协调者资源，开销⼤。⼀句话总结就是：2PC效率很低，对⾼并发很不友好。

![](../imgs/dis_tran.png)

**三阶段提交：**

1. 概念：三阶段提交协议在协调者和参与者中都引⼊超时机制，并且把两阶段提交协议的第⼀个阶段拆分成了两步：询问，然后再锁资源，最后真正提交。这样三阶段提交就有CanCommit、PreCommit、DoCommit三个阶段。
2. 缺点：如果进⼊PreCommit后，Coordinator发出的是abort请求，假设只有⼀个Cohort收到并进⾏了abort操作，⽽其他对于系统状态未知的Cohort会根据3PC选择继续Commit，此时系统状态发⽣不⼀致性。

![](../imgs/dis_tran_thr.png)

## 解释一下柔韧性事务？ ⭐⭐⭐ :id=flex-affair
1. 概念：所谓柔性事务是相对强制锁表的刚性事务⽽⾔。流程⼊下：服务器A的事务如果执⾏顺利，那么事务A就先⾏提交，如果事务B也执⾏顺利，则事务B也提交，整个事务就算完成。但是如果事务B执⾏失败，事务B本身回滚，这时事务A已经被提交，所以需要执⾏⼀个补偿操作，将已经提交的事务A执⾏的操作作反操作，恢复到未执⾏前事务A的状态。
1. 缺点：业务侵⼊性太强，还要补偿操作，缺乏普遍性，没法⼤规模推⼴。

消息最终⼀致性解决⽅案之RabbitMQ实现：

实现：发送⽅确认+消息持久化+消费者确认。

## 什么时候用到分布式开发？ ⭐⭐⭐ :id=dis-dev
**优点：**

1. 模块解耦：把模块拆分,使⽤接⼝通信,降低模块之间的耦合度.
1. 项⽬拆分，不同团队负责不同的⼦项⽬：把项⽬拆分成若⼲个⼦项⽬,不同的团队负责不同的⼦项⽬.
1. 提⾼项⽬扩展性：增加功能时只需要再增加⼀个⼦项⽬,调⽤其他系统的接⼝就可以。
1. 分布式部署：可以灵活的进⾏分布式部署.
1. 提⾼代码的复⽤性：⽐如service层,如果不采⽤分布式rest服务⽅式架构就会在⼿机wap商城,微信商城,pc,android，ios每个端都要写⼀个service层逻辑,开发量⼤,难以维护⼀起升级,这时候就可以采⽤分布式rest服务⽅式,公⽤⼀个service层。

**缺点：**

1. 系统之间的交互要使⽤远程通信,接⼝开发增⼤⼯作量；
1. ⽹络请求有延时；
1. 事务处理⽐较麻烦，需要使⽤分布式事务。

## 说一下CDN(异地多活)？ ⭐ :id=area-live
**异地多活**：异地多活指分布在异地的多个站点同时对外提供服务的业务场景。异地多活是⾼可⽤架构设计的⼀种，与传统的灾备设计的最主要区别在于“多活”，即所有站点都是同时在对外提供服务的。

**两地容灾切换⽅案**：容灾是异地多活中最核⼼的⼀环， 以两个城市异地多活部署架构图为例。

![](../imgs/cdn_two.png)

在两个城市（城市1位于华南1地域、城市2位于华东1地域）均部署⼀套完整的业务系统。
下单业务按照“user_id”％ 100 进⾏分⽚，在正常情况下：

1. [00~49]分⽚所有的读写都在城市1的数据库实例主库。
1. [50～99]分⽚所有的读写都在城市2的数据库实例主库。

“城市1的数据库实例主库”和 “城市2的数据库实例主库”建⽴DTS双向复制。

当出现异常时，需要进⾏容灾切换。可能出现的场景有以下4种：

![](../imgs/cdn_1.png)

将第2种、第3种异常情况，全部采⽤第2种⽅案进⾏处理，那么不管是所有的APP Server异常、所有的数据库异常、整个城市异常，就直接按照城市级容灾⽅案处理，直接将APP Server、数据库切换到到另⼀个城市。

**多城异地多活：**
1. 多城市异地多活模式指的是3个或者3个以上城市间部署异地多活。该模式下存在中⼼节点和单元节点：
1. 中⼼节点：指单元节点的增量数据都需要实时的同步到中⼼节点，同时中⼼节点将所有分⽚的增量数据同步到其他单元节点。
1. 单元节点：即对应分⽚读写的节点，该节点需要将该分⽚的增量同步到中⼼节点，并且接收来⾃于中⼼节点的其他分⽚的增量数据。

![](../imgs/cdn_2.png)

## 分布式环境下宕机的处理方案？ ⭐ :id=crane
1. dubbo：服务器宕机，zk临时被删除；
1. springcloud：每30s发送⼼跳检测重新进⾏租约，如果客户端不能多次更新租约，它将在90s内从服务器注册中⼼移除。
1. apm监控